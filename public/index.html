<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CyberPuck</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        background: linear-gradient(45deg, #0d0d1a, #1a1a3a);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: "Orbitron", monospace;
        color: #00ffcc;
        overflow: hidden;
      }
      canvas {
        border-radius: 2.5%;
        width: 70vw;
        height: 90vh;
      }
      #status {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: #00ffcc;
        text-shadow: 0 0 10px #00ffcc, 0 0 20px #ff007a;
        font-size: clamp(16px, 2vw, 24px);
        text-align: center;
        z-index: 10;
      }
      #server {
        position: absolute;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        color: #ff007a;
        text-shadow: 0 0 10px #ff007a;
        font-size: clamp(14px, 1.8vw, 20px);
        z-index: 10;
      }
      #timer {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        color: #ff00ff;
        text-shadow: 0 0 10px #ff00ff;
        font-size: clamp(14px, 1.8vw, 20px);
        z-index: 10;
      }
      #newGameButton {
        position: absolute;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: transparent;
        border: 2px solid #ff007a;
        color: #00ffcc;
        font-family: "Orbitron", monospace;
        font-size: clamp(14px, 1.8vw, 18px);
        text-shadow: 0 0 5px #00ffcc;
        box-shadow: 0 0 10px #ff007a;
        cursor: pointer;
        z-index: 10;
        touch-action: manipulation;
        display: none;
      }
      #newGameButton:hover {
        background: #ff007a;
        color: #0d0d1a;
        text-shadow: none;
      }
      #fullscreenButton {
        position: absolute;
        top: 120px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: #00ffcc;
        border: 2px solid #00ffcc;
        color: #ff007a;
        font-family: "Orbitron", monospace;
        font-size: clamp(12px, 1.6vw, 16px);
        text-shadow: 0 0 5px #ff007a;
        box-shadow: 0 0 10px #00ffcc;
        cursor: pointer;
        z-index: 10;
        touch-action: manipulation;
        display: none;
      }
      #fullscreenButton:hover {
        background: #00ffcc;
        color: #0d0d1a;
        text-shadow: none;
      }
      @media screen and (max-width: 768px) {
        #newGameButton {
          top: 15vh;
          padding: 8px 16px;
          font-size: clamp(12px, 4vw, 16px);
        }
        #fullscreenButton {
          top: 22vh;
          padding: 8px 16px;
          font-size: clamp(12px, 4vw, 16px);
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <div id="status">Ожидание второго игрока...</div>
    <div id="game-container"></div>
    <script src="game.js"></script>
        }
      }

      document.addEventListener("DOMContentLoaded", setupFullscreenButton);

      document.addEventListener("fullscreenchange", () => {
        windowResized();
        if (!document.fullscreenElement) {
          document.getElementById("fullscreenButton").innerText =
            "Полноэкранный режим";
        }
      });
      document.addEventListener("webkitfullscreenchange", () => {
        windowResized();
        if (!document.fullscreenElement) {
          document.getElementById("fullscreenButton").innerText =
            "Полноэкранный режим";
        }
      });

      function mouseMoved() {
        if (gameState !== "playing" || !playerId) return;

        let currentTime = millis();
        if (currentTime - lastMoveSent < moveSendInterval) return;

        let targetX = constrain(mouseX / width, 0, 1 - paddleWidth);
        let targetY;
        if (playerId === 1) {
          targetY = constrain(mouseY / height, 0.5, 1 - paddleHeight);
        } else {
          targetY = 1 - mouseY / height;
          targetY = constrain(targetY, 0, 0.5 - paddleHeight);
        }

        console.log(
          `Игрок ${playerId}: mouseX=${targetX.toFixed(
            3
          )}, mouseY=${targetY.toFixed(3)}`
        );

        if (ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "move",
              position: { x: targetX, y: targetY },
              playerId,
            })
          );
          lastMoveSent = currentTime;
        }
      }

      function touchStarted() {
        if (gameState !== "playing" || !playerId) {
          doubleTap();
          return false;
        }
        const touch = touches[0];
        if (touch) {
          const elements = document.elementsFromPoint(touch.x, touch.y);
          if (
            elements.includes(document.getElementById("newGameButton")) ||
            elements.includes(document.getElementById("fullscreenButton"))
          ) {
            return false;
          }
        }
        return false;
      }

      function touchMoved() {
        if (gameState !== "playing" || !playerId) return false;
        const touch = touches[0];
        if (touch) {
          const elements = document.elementsFromPoint(touch.x, touch.y);
          if (
            elements.includes(document.getElementById("newGameButton")) ||
            elements.includes(document.getElementById("fullscreenButton"))
          ) {
            return false;
          }
        }
        let currentTime = millis();
        if (currentTime - lastMoveSent < moveSendInterval) return false;

        let touchX = touch.x / width;
        let touchY = touch.y / height;

        const offsetX = isMobileDevice() ? (width < 600 ? 0.03 : 0.02) : 0;
        const offsetY = isMobileDevice() ? (height < 800 ? 0.05 : 0.04) : 0;

        if (playerId === 1) {
          touchX = constrain(touchX + offsetX, 0, 1 - paddleWidth);
          touchY = constrain(touchY - offsetY, 0.5, 1 - paddleHeight);
        } else {
          touchX = constrain(touchX + offsetX, 0, 1 - paddleWidth);
          touchY = 1 - touchY;
          touchY = constrain(touchY - offsetY, 0, 0.5 - paddleHeight);
        }

        console.log(
          `Игрок ${playerId}: touchX=${touchX.toFixed(
            3
          )}, touchY=${touchY.toFixed(3)}`
        );
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(
            JSON.stringify({
              type: "move",
              position: { x: touchX, y: touchY },
              playerId,
            })
          );
          lastMoveSent = currentTime;
        }
        return false;
      }

      document.addEventListener("DOMContentLoaded", () => {
        setupFullscreenButton();
        const newGameButton = document.getElementById("newGameButton");
        newGameButton.addEventListener("click", requestNewGame);
        newGameButton.addEventListener("touchstart", (e) => {
          e.preventDefault();
          requestNewGame();
        });
        const fullscreenButton = document.getElementById("fullscreenButton");
        fullscreenButton.addEventListener("click", toggleFullscreen);
        fullscreenButton.addEventListener("touchstart", (e) => {
          e.preventDefault();
          toggleFullscreen();
        });
      });

      function touchEnded() {
        return false;
      }

      function update() {
        if (gameState === "playing") {
          ballTrail.push({ x: ball.x, y: ball.y, alpha: 100 });
          if (ballTrail.length > 10) {
            ballTrail.shift();
          }
        }
      }

      let lastTouchTime = 0;
      function doubleTap() {
        const currentTime = new Date().getTime();
        const tapInterval = currentTime - lastTouchTime;
        if (tapInterval < 300 && tapInterval > 0) {
          if (document.fullscreenElement) {
            toggleFullscreen();
          }
        }
        lastTouchTime = currentTime;
      }

      function touchStarted() {
        if (gameState !== "playing" || !playerId) {
          doubleTap();
          return false;
        }
        return false;
      }
    </script>
  </body>
</html>
